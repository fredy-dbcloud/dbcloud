# Transactional Email & Monthly Summary System

## Overview

This document describes the transactional email system and automatic monthly summary generation implemented for DBCloud.

## Edge Functions

### 1. `send-transactional-email`

Sends professional, branded transactional emails with full EN/ES support.

**Supported Email Types:**
- `purchase_confirmation` - Welcome email after purchase
- `request_submitted` - Confirmation when a request is submitted
- `request_status_update` - Notification when request status changes
- `monthly_summary` - Monthly summary notification

**Usage:**
```typescript
import { useTransactionalEmail } from '@/hooks/useTransactionalEmail';

const { sendPurchaseConfirmation, sendRequestSubmitted } = useTransactionalEmail();

// Send purchase confirmation
await sendPurchaseConfirmation(
  'user@example.com',
  'en',
  'Starter Consulting',
  'Monthly',
  'https://dbcloud.io/en/portal'
);
```

### 2. `generate-monthly-summary`

Automatically generates monthly summaries for all clients or a specific user.

**Parameters:**
- `user_id` (optional) - Generate for specific user, or all if null
- `month` (optional) - Month number (1-12), defaults to previous month
- `year` (optional) - Year, defaults to current year
- `send_email` (optional) - Whether to send email notification, defaults to true

**Usage (via cron):**
```sql
-- Run on the 1st of each month at 9:00 AM UTC
SELECT cron.schedule(
  'generate-monthly-summaries',
  '0 9 1 * *',
  $$
  SELECT net.http_post(
    url := 'https://wtunmdumgrjcfgejyedr.supabase.co/functions/v1/generate-monthly-summary',
    headers := '{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb,
    body := '{"send_email": true}'::jsonb
  ) as request_id;
  $$
);
```

## Email Templates

All emails follow enterprise standards:
- Clear subject lines
- Single primary CTA
- DBCloud branding
- Portal-first footer messaging
- Full EN/ES parity

## Frontend Integration

### Purchase Confirmation
Automatically sent from `CheckoutSuccessPage.tsx` when a session_id is present.

### Request Submitted
Automatically sent from `ClientRequestForm.tsx` after successful submission.

### Monthly Summary
Generated by scheduled cron job; users view full report in Portal.

## Monthly Summary Report Structure

1. **Account Overview** - Plan, billing period, hours
2. **Work Activity** - Requests submitted/completed/pending
3. **Value Delivered** - Performance improvements, cost optimizations, risks prevented
4. **Recommendations** - Context-aware suggestions (labeled as optional)
5. **Transparency Notice** - Informational disclaimer

## Configuration Required

### Resend API Key
The `RESEND_API_KEY` secret must be configured in Supabase for email sending.

### Domain Verification
The sending domain (dbcloud.us) must be verified in Resend dashboard.

---

## Cron Security (CRON_SECRET)

The monthly summary generation is triggered by a pg_cron scheduled job. For security, the edge function validates a shared secret header instead of using hardcoded JWTs.

### Setup

1. **Set CRON_SECRET in Supabase Secrets**
   - Go to Lovable Cloud → Secrets
   - Add `CRON_SECRET` with a strong random value (e.g., `openssl rand -base64 32`)
   - The edge function will read this from `Deno.env.get("CRON_SECRET")`

2. **Configure pg_cron Schedule**
   
   First, unschedule any existing job:
   ```sql
   SELECT cron.unschedule('generate-monthly-summaries');
   ```
   
   Then create the secure schedule (replace `YOUR_CRON_SECRET_VALUE` with your actual secret):
   ```sql
   SELECT cron.schedule(
     'generate-monthly-summaries',
     '0 9 1 * *',
     $$
     SELECT net.http_post(
       url := 'https://wtunmdumgrjcfgejyedr.supabase.co/functions/v1/generate-monthly-summary',
       headers := jsonb_build_object(
         'Content-Type', 'application/json',
         'X-Cron-Secret', 'YOUR_CRON_SECRET_VALUE'
       ),
       body := '{"send_email": true}'::jsonb
     ) as request_id;
     $$
   );
   ```

   **Note**: pg_cron cannot read Supabase edge function secrets directly. You must manually substitute the secret value in the SQL. This is a known limitation.

### Secret Rotation Procedure

To rotate CRON_SECRET safely without downtime:

1. **Generate new secret**: `openssl rand -base64 32`

2. **Update Supabase secret**: Add the new value to `CRON_SECRET` in Lovable Cloud → Secrets

3. **Update pg_cron schedule**: Run the schedule SQL with the new secret value

4. **Verify**: Manually test the function:
   ```bash
   curl -X POST \
     'https://wtunmdumgrjcfgejyedr.supabase.co/functions/v1/generate-monthly-summary' \
     -H 'Content-Type: application/json' \
     -H 'X-Cron-Secret: YOUR_NEW_SECRET' \
     -d '{"send_email": false}'
   ```

5. **Confirm logs**: Check edge function logs for "[CRON-AUTH] Cron authentication successful"

### Idempotency

The summary generation is idempotent per (user_id, month, year):
- If a summary already exists for a user/month, it updates instead of creating duplicates
- The `client_summaries` table has a unique constraint on `(user_id, month, year)`
- Safe to run the cron job multiple times without creating duplicate records

### Security Notes

- The secret is **never logged** (only auth success/failure is logged)
- Returns 401 "Unauthorized cron" if:
  - `X-Cron-Secret` header is missing
  - Secret doesn't match `CRON_SECRET` environment variable
  - `CRON_SECRET` is not configured
- CORS headers allow the header for browser-based testing if needed
