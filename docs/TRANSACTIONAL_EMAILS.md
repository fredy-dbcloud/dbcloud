# Transactional Email & Monthly Summary System

## Overview

This document describes the transactional email system and automatic monthly summary generation implemented for DBCloud.

## Edge Functions

### 1. `send-transactional-email`

Sends professional, branded transactional emails with full EN/ES support.

**Supported Email Types:**
- `purchase_confirmation` - Welcome email after purchase
- `request_submitted` - Confirmation when a request is submitted
- `request_status_update` - Notification when request status changes
- `monthly_summary` - Monthly summary notification

**Usage:**
```typescript
import { useTransactionalEmail } from '@/hooks/useTransactionalEmail';

const { sendPurchaseConfirmation, sendRequestSubmitted } = useTransactionalEmail();

// Send purchase confirmation
await sendPurchaseConfirmation(
  'user@example.com',
  'en',
  'Starter Consulting',
  'Monthly',
  'https://dbcloud.io/en/portal'
);
```

### 2. `generate-monthly-summary`

Automatically generates monthly summaries for all clients or a specific user.

**Parameters:**
- `user_id` (optional) - Generate for specific user, or all if null
- `month` (optional) - Month number (1-12), defaults to previous month
- `year` (optional) - Year, defaults to current year
- `send_email` (optional) - Whether to send email notification, defaults to true

**Usage (via cron):**
```sql
-- Run on the 1st of each month at 9:00 AM UTC
SELECT cron.schedule(
  'generate-monthly-summaries',
  '0 9 1 * *',
  $$
  SELECT net.http_post(
    url := 'https://wtunmdumgrjcfgejyedr.supabase.co/functions/v1/generate-monthly-summary',
    headers := '{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb,
    body := '{"send_email": true}'::jsonb
  ) as request_id;
  $$
);
```

## Email Templates

All emails follow enterprise standards:
- Clear subject lines
- Single primary CTA
- DBCloud branding
- Portal-first footer messaging
- Full EN/ES parity

## Frontend Integration

### Purchase Confirmation
Automatically sent from `CheckoutSuccessPage.tsx` when a session_id is present.

### Request Submitted
Automatically sent from `ClientRequestForm.tsx` after successful submission.

### Monthly Summary
Generated by scheduled cron job; users view full report in Portal.

## Monthly Summary Report Structure

1. **Account Overview** - Plan, billing period, hours
2. **Work Activity** - Requests submitted/completed/pending
3. **Value Delivered** - Performance improvements, cost optimizations, risks prevented
4. **Recommendations** - Context-aware suggestions (labeled as optional)
5. **Transparency Notice** - Informational disclaimer

## Configuration Required

### Resend API Key
The `RESEND_API_KEY` secret must be configured in Supabase for email sending.

### Domain Verification
The sending domain (dbcloud.io) must be verified in Resend dashboard.

### Cron Setup
Enable `pg_cron` and `pg_net` extensions, then create the schedule as shown above.
